% Document Header
\documentclass[tikz,border=12pt,12pt]{standalone}
\hyphenpenalty=10000
\input{style/new_sequence.tikz}
\input{vars/shortcuts.tex}
\begin{document}
\begin{tikzpicture}

% Stage "consumer"
\node[participant] at (0,2) {Consumer};
\node[icon] (icon0) at (0,3.5) {\includegraphics[width=.1\textwidth] {consumer.png}};
\draw[aidline] (0, 0.9) -- (0,-18);

% Stage "merchant"
\node[participant] at (9,2) {Merchant};
\node[icon] (icon1) at (9,3.5) {\includegraphics[width=.1\textwidth] {merchant.png}};
\draw[aidline] (9, 0.9) -- (9,-18);

% Stage "payment"
\node[participant] at (18,2) {Payment Gateway};
\node[icon] (icon2) at (18,3.5) {\includegraphics[width=.1\textwidth] {paymentgateway.png}};
\draw[aidline] (18, 0.9) -- (18,-18);

% Stage "wbank"
\node[participant] at (27,2) {Wirecard Bank};
\node[icon] (icon3) at (27,3.5) {\includegraphics[width=.1\textwidth] {bank.png}};
\draw[aidline] (27, 0.9) -- (27,-18);

% Stage "cbank"
\node[participant] at (36,2) {Consumer's Bank};
\node[icon] (icon4) at (36,3.5) {\includegraphics[width=.1\textwidth] {financialinstitution.png}};
\draw[aidline] (36, 0.9) -- (36,-18);

% Boxes
\draw[box, nightblue] (0,0.5) -- (0,-0.5);
\draw[box, nightblue] (9,0.1) -- (9,-2.6);
\draw[box, nightblue] (18,-2.4) -- (18,-5.1);
\draw[box, nightblue] (27,-4.9) -- (27,-13.85);
\draw[box, nightblue] (36,-13.65) -- (36,-17.6);

% Flows
% Flow "1 Enters credit card details at checkout"
\draw[solidarrow]
(0.21,0) -- node[txt, midway,above] {1 Enters credit card details at checkout} (8.79,0);
% Flow "2 Records data"
\draw[solidarrow]
(9.21,0) -- (9.61,0) -- node[txt, midway,right] {2 Records data} (9.61,-1.25) -- (9.21,-1.25);
% Flow "3 Posts XML request with default identifiers"
\draw[solidarrow]
(9.21,-2.5) -- node[txt, midway,above] {3 Posts XML request with default identifiers} (17.79,-2.5);
% Flow "4 Processes request"
\draw[solidarrow]
(18.21,-2.5) -- (18.61,-2.5) -- node[txt, midway,right] {4 Processes request} (18.61,-3.75) -- (18.21,-3.75);
% Flow "5 Forwards transaction details"
\draw[solidarrow]
(18.21,-5) -- node[txt, midway,above] {5 Forwards transaction details} (26.79,-5);
% Flow "6 Acquires card and sales details"
\draw[solidarrow]
(27.21,-5) -- (27.61,-5) -- node[txt, midway,right] {6 Acquires card and sales details} (27.61,-6.25) -- (27.21,-6.25);
% Flow "7 Checks identifiers and \\ merchant's details"
\draw[solidarrow]
(27.21,-7.5) -- (27.61,-7.5) -- node[txt, midway,right] {7 Checks identifiers and \\ merchant's details} (27.61,-8.75) -- (27.21,-8.75);
% Flow "8 Complements data with data from transaction identifier tag"
\draw[solidarrow]
(27.21,-10) -- (27.61,-10) -- node[txt, midway,right] {8 Complements data with data from transaction identifier tag} (27.61,-11.25) -- (27.21,-11.25);
% Flow "9 Routes settlement request incl. Dynamic Descriptor"
\draw[solidarrow]
(27.21,-13.75) -- node[txt, midway,above] {9 Routes settlement request incl. Dynamic Descriptor} (35.79,-13.75);
% Flow "10 Processes request and debits consumer's account"
\draw[solidarrow]
(36.21,-13.75) -- (36.61,-13.75) -- node[txt, midway,right] {10 Processes request and debits consumer's account} (36.61,-15) -- (36.21,-15);
% Flow "11 Adds new debit item with \\ Dynamic Descriptor to credit card statement"
\draw[solidarrow]
(36.21,-16.25) -- (36.61,-16.25) -- node[txt, midway,right] {11 Adds new debit item with \\ Dynamic Descriptor to credit card statement} (36.61,-17.5) -- (36.21,-17.5);

% Document Footer
\end{tikzpicture}
\end{document}
